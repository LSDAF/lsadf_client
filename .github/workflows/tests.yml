name: Run tests

run-name: ${{ github.head_ref || github.ref_name }}-run-tests

on:
    pull_request:
        paths-ignore:
            - '**.yml'
            - '**.md'
    workflow_dispatch:


concurrency:
    group: run-tests-${{ github.event.number }}
    cancel-in-progress: true


jobs:
    unit-test:
        name: "Run Unit Tests"
        runs-on: 'ubuntu-22.04'
        timeout-minutes: 10 # The overall timeout
        permissions:
            actions: write
            checks: write
            contents: write
            pull-requests: write
            statuses: write

        steps:
            # checkout your repository
            -   uses: actions/checkout@v4
                with:
                    lfs: true

            # run tests by using the gdUnit4-action with Godot version 4.2.1 and the latest GdUnit4 release
            -   uses: MikeSchulze/gdUnit4-action@v1.1.1
                with:
                    godot-version: '4.3'
                    paths: |
                        res://tests/
                    timeout: 5
                    report-name: tests_report.xml

            # download the artifact
            -   name: Download test report artifact
                uses: actions/download-artifact@v3
                with:
                    name: artifact_test_report.xml
                    path: ./test-report

            # unzip the artifact
            -   name: Unzip test report artifact
                run: unzip ./test-report/artifact_test_report.xml.zip -d ./test-report

            # serve the folder with HTML files
            -   name: Serve test report
                run: |
                    sudo apt-get install -y python3
                    python3 -m http.server --directory ./test-report 8080 &
                continue-on-error: true

            # print the URL to access the report
            -   name: Print report URL
                run:
                    echo "Report URL: http://localhost:8080/report.html"